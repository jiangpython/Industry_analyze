# è´¢åŠ¡æ•°æ®é‡‡é›†åŠŸèƒ½ä¿®å¤è¯´æ˜

## é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
ç”¨æˆ·è¯·æ±‚è´¢åŠ¡æ•°æ®æ—¶ï¼Œç³»ç»Ÿç›´æ¥è¿”å›404é”™è¯¯ï¼Œæ²¡æœ‰è‡ªåŠ¨å¯åŠ¨æ•°æ®é‡‡é›†ã€‚

### æ ¹æœ¬åŸå› 
1. **ç¼ºå°‘è‡ªåŠ¨é‡‡é›†é€»è¾‘**ï¼šå½“æœ¬åœ°æ²¡æœ‰æ•°æ®æ—¶ï¼Œç›´æ¥è¿”å›é”™è¯¯
2. **å®æ—¶æ•°æ®æœåŠ¡æœªå®ç°**ï¼š`RealtimeDataService` çš„è´¢åŠ¡æ•°æ®è·å–æ–¹æ³•è¢«æ³¨é‡Š
3. **æ²¡æœ‰é™çº§é‡‡é›†æœºåˆ¶**ï¼šç¼ºå°‘ä»ç½‘ç»œè‡ªåŠ¨é‡‡é›†æ•°æ®çš„é€»è¾‘

## ä¿®å¤å†…å®¹

### 1. å®ç°è´¢åŠ¡æ•°æ®é‡‡é›†æœåŠ¡

**æ–‡ä»¶**: `app/services/realtime_data_service.py`

æ–°å¢æ–¹æ³•ï¼š
- `get_financial_data()` - è·å–å…¬å¸è´¢åŠ¡æ•°æ®ï¼ˆæ··åˆæ¨¡å¼ï¼‰
- `_fetch_financial_data()` - ä»AKShareé‡‡é›†è´¢åŠ¡æ•°æ®

**é‡‡é›†é€»è¾‘**ï¼š
```python
def get_financial_data(self, company_code: str, force_refresh: bool = False):
    # 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
    # 2. å®æ—¶é‡‡é›†è´¢åŠ¡æ•°æ®
    # 3. ä¿å­˜åˆ°æœ¬åœ°
    # 4. é™çº§åˆ°æœ¬åœ°å­˜å‚¨
```

### 2. ä¿®å¤APIç«¯ç‚¹é€»è¾‘

**æ–‡ä»¶**: `app/api/endpoints/companies_simple.py`

**ä¿®å¤å‰**ï¼š
```python
if not financial_records:
    raise HTTPException(status_code=404, detail="æœªæ‰¾åˆ°è´¢åŠ¡æ•°æ®")
```

**ä¿®å¤å**ï¼š
```python
# 1. ä¼˜å…ˆå°è¯•å®æ—¶æ•°æ®é‡‡é›†
if force_refresh:
    financial_records = realtime_service.get_financial_data(company_code, force_refresh)

# 2. å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œè‡ªåŠ¨å¯åŠ¨é‡‡é›†
if not financial_records:
    financial_records = data_manager.get_financial_data(company_code)
    
    # å¦‚æœæœ¬åœ°ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œå°è¯•å®æ—¶é‡‡é›†
    if not financial_records:
        financial_records = realtime_service.get_financial_data(company_code, force_refresh=True)

# 3. å¦‚æœä»ç„¶æ²¡æœ‰æ•°æ®ï¼Œè¿”å›é”™è¯¯
if not financial_records:
    raise HTTPException(status_code=404, detail=f"æœªæ‰¾åˆ°å…¬å¸ {company_code} çš„è´¢åŠ¡æ•°æ®")
```

### 3. æ•°æ®é‡‡é›†åŠŸèƒ½

**æ”¯æŒçš„è´¢åŠ¡æ•°æ®**ï¼š
- èµ„äº§è´Ÿå€ºè¡¨
- åˆ©æ¶¦è¡¨  
- ç°é‡‘æµé‡è¡¨

**æ•°æ®æº**ï¼šAKShare
**æ•°æ®æ ¼å¼**ï¼šJSON
**å­˜å‚¨ä½ç½®**ï¼š`data/financial_data.json`

## æ–°çš„å·¥ä½œæµç¨‹

### ç”¨æˆ·è¯·æ±‚è´¢åŠ¡æ•°æ®æ—¶çš„å¤„ç†æµç¨‹ï¼š

```
ç”¨æˆ·è¯·æ±‚è´¢åŠ¡æ•°æ®
    â†“
æ£€æŸ¥æœ¬åœ°ç¼“å­˜
    â†“
æœ¬åœ°æœ‰æ•°æ®ï¼Ÿ â†’ è¿”å›æœ¬åœ°æ•°æ®
    â†“ å¦
å°è¯•å®æ—¶æ•°æ®é‡‡é›†
    â†“
é‡‡é›†æˆåŠŸï¼Ÿ â†’ ä¿å­˜åˆ°æœ¬åœ°å¹¶è¿”å›
    â†“ å¦
å°è¯•æœ¬åœ°æ•°æ®é‡‡é›†ï¼ˆAKShareç­‰ï¼‰
    â†“
é‡‡é›†æˆåŠŸï¼Ÿ â†’ ä¿å­˜åˆ°æœ¬åœ°å¹¶è¿”å›
    â†“ å¦
è¿”å›404é”™è¯¯ï¼ˆåŒ…å«è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼‰
```

### æ”¯æŒçš„æ“ä½œæ¨¡å¼ï¼š

1. **æ™ºèƒ½æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰
   ```bash
   GET /api/v1/companies/000999/financial-data
   ```
   - ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜
   - æœ¬åœ°æ— æ•°æ®æ—¶è‡ªåŠ¨é‡‡é›†

2. **å¼ºåˆ¶åˆ·æ–°æ¨¡å¼**
   ```bash
   GET /api/v1/companies/000999/financial-data?force_refresh=true
   ```
   - å¼ºåˆ¶é‡æ–°é‡‡é›†æ•°æ®
   - å¿½ç•¥æœ¬åœ°ç¼“å­˜

3. **ç­›é€‰æ¨¡å¼**
   ```bash
   GET /api/v1/companies/000999/financial-data?data_type=quarterly&start_date=2023-01-01&end_date=2025-01-01
   ```
   - æŒ‰æ•°æ®ç±»å‹ç­›é€‰
   - æŒ‰æ—¶é—´èŒƒå›´ç­›é€‰

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
è¿è¡Œ `test_financial_data.py` æ¥éªŒè¯ä¿®å¤ï¼š

```bash
python test_financial_data.py
```

### æ‰‹åŠ¨æµ‹è¯•
```bash
# æµ‹è¯•è‡ªåŠ¨é‡‡é›†
curl -X GET "http://localhost:8000/api/v1/companies/000999/financial-data"

# æµ‹è¯•å¼ºåˆ¶åˆ·æ–°
curl -X GET "http://localhost:8000/api/v1/companies/000999/financial-data?force_refresh=true"

# æµ‹è¯•ç­›é€‰åŠŸèƒ½
curl -X GET "http://localhost:8000/api/v1/companies/000999/financial-data?data_type=quarterly&start_date=2023-01-01&end_date=2025-01-01"
```

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- **æœ¬åœ°ç¼“å­˜**ï¼šè´¢åŠ¡æ•°æ®æ°¸ä¹…ä¿å­˜
- **å®æ—¶ç¼“å­˜**ï¼š5åˆ†é’Ÿæœ‰æ•ˆæœŸ
- **æ™ºèƒ½æ›´æ–°**ï¼šåªè·å–ç¼ºå¤±çš„æ•°æ®

### é”™è¯¯å¤„ç†
- **ç½‘ç»œå¼‚å¸¸**ï¼šè‡ªåŠ¨é™çº§åˆ°æœ¬åœ°æ•°æ®
- **æ•°æ®æºå¼‚å¸¸**ï¼šæä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- **æ ¼å¼å¼‚å¸¸**ï¼šè‡ªåŠ¨æ•°æ®æ¸…æ´—å’Œè½¬æ¢

## ä½¿ç”¨å»ºè®®

### 1. é¦–æ¬¡ä½¿ç”¨
```bash
# å¯åŠ¨æœåŠ¡å™¨
python run.py

# æµ‹è¯•æ•°æ®é‡‡é›†
curl -X GET "http://localhost:8000/api/v1/companies/000001/financial-data"
```

### 2. æ‰¹é‡é‡‡é›†
```bash
# å¯ä»¥åŒæ—¶è¯·æ±‚å¤šä¸ªå…¬å¸çš„æ•°æ®
# ç³»ç»Ÿä¼šè‡ªåŠ¨å¹¶è¡Œå¤„ç†
```

### 3. æ•°æ®ç®¡ç†
```bash
# æŸ¥çœ‹æœ¬åœ°æ•°æ®
ls -la data/

# æ¸…ç†ç¼“å­˜
rm data/cache.json
```

## æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œä¾èµ–**ï¼šé¦–æ¬¡é‡‡é›†éœ€è¦ç½‘ç»œè¿æ¥
2. **æ•°æ®æºé™åˆ¶**ï¼šä¾èµ–AKShareæ•°æ®æºçš„å¯ç”¨æ€§
3. **é‡‡é›†æ—¶é—´**ï¼šé¦–æ¬¡é‡‡é›†å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ
4. **æ•°æ®å‡†ç¡®æ€§**ï¼šå»ºè®®éªŒè¯é‡‡é›†çš„æ•°æ®å‡†ç¡®æ€§

## æ€»ç»“

âœ… **ä¿®å¤å®Œæˆ**
- å®ç°äº†è‡ªåŠ¨æ•°æ®é‡‡é›†åŠŸèƒ½
- ä¿®å¤äº†APIç«¯ç‚¹çš„é€»è¾‘é—®é¢˜
- æ·»åŠ äº†å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
- æä¾›äº†æµ‹è¯•éªŒè¯å·¥å…·

ç°åœ¨æ‚¨çš„ç³»ç»Ÿå…·å¤‡äº†å®Œæ•´çš„è´¢åŠ¡æ•°æ®é‡‡é›†èƒ½åŠ›ï¼ğŸ‰ 